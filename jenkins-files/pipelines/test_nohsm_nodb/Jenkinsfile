node('dss-docker-slave') {

   checkout([$class: 'SubversionSCM', additionalCredentials: [], excludedCommitMessages: '', excludedRegions: '', excludedRevprop: '', excludedUsers: '', filterChangelog: false, ignoreDirPropChanges: false, includedRegions: '', locations: [[cancelProcessOnExternalsFail: true, credentialsId: 'e8aa0eb0-9eb8-42d2-8596-6a7a90c8f7cc', depthOption: 'infinity', ignoreExternalsOption: true, local: '.', remote: 'https://svn.cesecore.eu/svn/signserver-restricted/trunk']], quietOperation: true, workspaceUpdater: [$class: 'UpdateUpdater']])

   def testImage   
   def PWD = pwd();
   // def CONTAINER_NAME = ${env.CONTAINER}
    
    stage('Prepare Container') {
        sh 'hostname'
        sh 'pwd'
        sh "cp -rv /home/jenkins/binaries `pwd`/jenkins-files/containers/${env.CONTAINER}/"
	sh 'which java'
    }

    stage('Build Container') {
        dockerfile {
            label 'dss-docker'
            dir "jenkins-files/containers/${env.CONTAINER}"
            filename 'Dockerfile'
            additionalBuildArgs  '--disable-content-trust=true --pull' // TODO: We want to find out how to run with content trust enabled for Red Hat images
            args '--group-add root --volume m2-repo:/m2-repo'
        }
        
        sh 'hostname'
        sh 'ls'
        testImage = docker.build("my-image2:${env.BUILD_ID}", "jenkins-files/containers/${env.CONTAINER}/")
        
    }

    testImage.inside {

        stage('Verify environment') {
         echo 'All environment variables'
         // sh '$JBOSS_EAP_VERSION'
         sh 'printenv'          
         sh "cat $JAVA_HOME/lib/security"
        }

        stage('Unpack') {
            sh 'rm -rf signserver-ee-*'
            //copyArtifacts filter: 'signserver-ee-*-bin.zip', fingerprintArtifacts: true, projectName: 'EE_trunk_Build_centos-7-openjdk-8-jdk_Unit', selector: lastSuccessful()
            copyArtifacts filter: 'signserver-ee-*-bin.zip', fingerprintArtifacts: true, projectName: "${env.UPSTREAM_BUILD_JOB}", selector: lastSuccessful()

            sh 'ls'
            sh 'unzip signserver-ee*.zip'
            sh 'rm signserver-ee*.zip'         
        }

        stage('Configure App Server') {
            sh "cp -v jenkins-files/pipelines/test_nohsm_nodb/${env.APPSERVER_STANDALONE_XML} /opt/jboss/${env.JBOSS_EAP_FOLDER}/standalone/configuration/standalone.xml"

            sh "mkdir /opt/jboss/${env.JBOSS_EAP_FOLDER}/standalone/configuration/keystore/"
            sh "cp -v jenkins-files/pipelines/test_nohsm_nodb/keystore.jks /opt/jboss/${env.JBOSS_EAP_FOLDER}/standalone/configuration/keystore/"
            sh "cp -v jenkins-files/pipelines/test_nohsm_nodb/truststore.jks /opt/jboss/${env.JBOSS_EAP_FOLDER}/standalone/configuration/keystore/"
            sh 'mkdir /tmp/data'
        }

        stage('Configure SignServer') {
            sh '''
                cd signserver-ee* && echo "
                    j2ee.web-nohttps=true
                    database.name=nodb
                    database.nodb.location=/tmp/data
                    database.username=NOT-USED
                    healthcheck.maintenancefile=${PWD}/maintenance.properties
                    web.admingui.dist.enabled=true
                    web.clientcli.dist.enabled=true" > conf/signserver_deploy.properties
            '''
            sh '''
                cd signserver-ee* && echo "
# Set root logger level to DEBUG for debug output.
log4j.rootLogger=DEBUG, A1

# A1 is set to be a ConsoleAppender. 
log4j.appender.A1=org.apache.log4j.ConsoleAppender

# A1 uses PatternLayout.
log4j.appender.A1.layout=org.apache.log4j.PatternLayout
log4j.appender.A1.layout.ConversionPattern=%d{ISO8601} %-5p [%c{1}] %m%n

# Limit categories related to the Database CLI
log4j.category.org.hibernate=WARN, A1
log4j.category.org.cesecore.keys.token.CryptoTokenFactory=WARN, A1
log4j.category.org.cesecore.keys.util.KeyTools=WARN, A1

# Limit categories related to JBoss AS 7/EAP6 remote EJB
#log4j.category.org.jboss.remoting=ERROR, A1
#log4j.category.org.jboss.ejb.client=ERROR, A1
#log4j.category.org.xnio=ERROR, A1" > conf/log4j.properties
            '''
sh 'cd signserver-ee* && mkdir p12 && mkdir jarsigner-test-files'

sh 'cd signserver-ee* && ls -ltr'
sh 'cd ${PWD}/jenkins-files/pipelines/test_nohsm_nodb &&  ls -ltr'

sh 'cd signserver-ee* && cp -v ../jenkins-files/pipelines/test_nohsm_nodb/keystore.jks p12/tomcat.jks'
sh 'cd signserver-ee* &&  cp -v ../jenkins-files/pipelines/test_nohsm_nodb/truststore.jks p12/'

sh 'cd signserver-ee*/lib/ext && cp -v commons-lang*.jar ../../jarsigner-test-files/'
sh 'cd signserver-ee*/lib/ext && cp -v log4j*.jar ../../jarsigner-test-files/'
sh 'cd signserver-ee*/lib/ext && cp -v cesecore-*.jar ../../jarsigner-test-files/'

         // Database audit log
            sh '''
                cd signserver-ee* && echo "          
databaseprotection.enablesign.AuditRecordData = true
databaseprotection.enableverify.AuditRecordData = true
databaseprotection.keyid = 400
databaseprotection.keyid.0 = 400
databaseprotection.keylabel.0 = dbStoreKey
databaseprotection.classname.0 = org.cesecore.keys.token.SoftCryptoToken
databaseprotection.properties.0 =
databaseprotection.data.0 = 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
databaseprotection.tokenpin.0 = userpin1
databaseprotection.version.0 = 2
                    " > conf/databaseprotection.properties
            '''

        }

        stage('Deploy SignServer') {
            sh 'cd signserver-ee* && ant -q deploy-ear'

            archiveArtifacts 'signserver-ee*/tmp/signserver.ear'
        }

        stage('Run') {
            sh 'hostname'
            sh 'ls'
            sh 'id'
            sh '$USER'   

            sh 'chmod +x jenkins-files/pipelines/test_nohsm_nodb/run.sh'
            sh 'jenkins-files/pipelines/test_nohsm_nodb/run.sh'

            //dir ('') {
            //    
            //}
        }
        stage('System Test') {            
                        // run system tests                                     
                        // sh 'cd signserver-ee* && bin/ant systemtest:jars -Dno.clover=true'

                        // gather the results
                         junit "signserver-ee*/tmp/test/results/TEST-*.xml"                                  
        }
    }

    //post {
    //    always {
    //        cleanWs()
    //    }
    //}
    
}
